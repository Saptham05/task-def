name: ECS Task Definition Management

################################################################################
# This workflow manages ECS Task Definitions using CloudFormation
# - Supports create, update, and delete operations
# - Uses AWS OIDC for secure authentication
# - Accepts task definition config from parameter file
# - Production-ready with comprehensive validation and error handling
################################################################################

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - update
          - delete
        default: 'create'
      
      environment:
        description: 'Target environment (e.g., dev, qa, staging, prod)'
        required: true
        type: string
        default: 'dev'
      
      task_family:
        description: 'Task Definition family name (e.g., my-app)'
        required: true
        type: string
      
      parameter_file_path:
        description: 'Path to parameter file in repository (e.g., config/dev/task-params.json)'
        required: true
        type: string
        default: 'parameters.json'
      
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'ap-south-1'
      
      cloudformation_template_path:
        description: 'Path to CloudFormation template'
        required: false
        type: string
        default: 'task-CTF.yaml'
      
      dry_run:
        description: 'Dry run mode (validation only, no deployment)'
        required: false
        type: boolean
        default: false

# Environment variables used across all jobs
env:
  AWS_REGION: ${{ inputs.aws_region }}
  STACK_NAME: ecs-taskdef-${{ inputs.task_family }}-${{ inputs.environment }}
  PARAMETER_FILE: ${{ inputs.parameter_file_path }}

jobs:
  ################################################################################
  # Job 1: Validate Inputs and Configuration
  ################################################################################
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      validation_status: ${{ steps.validate.outputs.status }}
      stack_exists: ${{ steps.check-stack.outputs.exists }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Validate Input Parameters
        id: validate
        run: |
          echo "::group::Input Validation"
          echo "Action: ${{ inputs.action }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Task Family: ${{ inputs.task_family }}"
          echo "Parameter File: ${{ env.PARAMETER_FILE }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "Stack Name: ${{ env.STACK_NAME }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo "::endgroup::"
          
          # Validate environment name format (alphanumeric, hyphens, underscores only)
          if [[ ! "${{ inputs.environment }}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "::error::Environment name must contain only alphanumeric characters, hyphens, and underscores"
            exit 1
          fi
          
          # Validate environment name length (CloudFormation stack name limits)
          ENV_LENGTH=${{ inputs.environment }}
          if [ "$ENV_LENGTH" -gt 50 ]; then
            echo "::error::Environment name must be 50 characters or less (current: $ENV_LENGTH)"
            exit 1
          fi
          
          # Validate task family name format
          if [[ ! "${{ inputs.task_family }}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "::error::Task family name must contain only alphanumeric characters, hyphens, and underscores"
            exit 1
          fi
          
          # Check if parameter file exists
          if [ ! -f "${{ env.PARAMETER_FILE }}" ]; then
            echo "::error::Parameter file not found: ${{ env.PARAMETER_FILE }}"
            exit 1
          fi
          
          # Validate JSON syntax of parameter file
          if ! jq empty "${{ env.PARAMETER_FILE }}" 2>/dev/null; then
            echo "::error::Parameter file is not valid JSON"
            exit 1
          fi
          
          # Check if CloudFormation template exists
          if [ ! -f "${{ inputs.cloudformation_template_path }}" ]; then
            echo "::error::CloudFormation template not found: ${{ inputs.cloudformation_template_path }}"
            exit 1
          fi
          
          echo "âœ… All validations passed"
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Display Parameter File Content
        run: |
          echo "::group::Parameter File Content"
          cat "${{ env.PARAMETER_FILE }}" | jq '.'
          echo "::endgroup::"
      
      # Configure AWS credentials using OIDC
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-ecs-taskdef-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS Authentication
        run: |
          echo "::group::AWS Identity"
          aws sts get-caller-identity
          echo "::endgroup::"
      
      - name: Check if Stack Exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}" \
            --output json > /dev/null 2>&1; then
            echo "Stack exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Stack does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Action Against Stack State
        run: |
          STACK_EXISTS="${{ steps.check-stack.outputs.exists }}"
          ACTION="${{ inputs.action }}"
          
          if [ "$ACTION" == "create" ] && [ "$STACK_EXISTS" == "true" ]; then
            echo "::error::Cannot create stack - it already exists. Use 'update' action instead."
            exit 1
          fi
          
          if [ "$ACTION" == "update" ] && [ "$STACK_EXISTS" == "false" ]; then
            echo "::error::Cannot update stack - it does not exist. Use 'create' action instead."
            exit 1
          fi
          
          if [ "$ACTION" == "delete" ] && [ "$STACK_EXISTS" == "false" ]; then
            echo "::error::Cannot delete stack - it does not exist."
            exit 1
          fi
          
          echo "âœ… Action '$ACTION' is valid for current stack state"

  ################################################################################
  # Job 2: Process Parameters and Prepare CloudFormation
  ################################################################################
  prepare:
    name: Prepare CloudFormation Parameters
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.validation_status == 'success'
    outputs:
      cf_parameters: ${{ steps.prepare-params.outputs.parameters }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Process Parameter File
        id: prepare-params
        run: |
          echo "::group::Processing Parameters"
          
          # Read the parameter file
          PARAMS=$(cat "${{ env.PARAMETER_FILE }}")
          
          # Extract and validate required parameters
          CONTAINER_IMAGE=$(echo "$PARAMS" | jq -r '.ContainerImage // empty')
          if [ -z "$CONTAINER_IMAGE" ]; then
            echo "::error::ContainerImage is required in parameter file"
            exit 1
          fi
          
          # Build CloudFormation parameters array
          CF_PARAMS=""
          
          # Add all parameters from the JSON file
          while IFS= read -r key; do
            value=$(echo "$PARAMS" | jq -r --arg k "$key" '.[$k]')
            
            # Handle different value types
            if [ "$value" != "null" ] && [ -n "$value" ]; then
              # For arrays and objects, convert to JSON string
              if echo "$value" | jq -e . >/dev/null 2>&1; then
                # It's valid JSON, check if it's array or object
                if echo "$value" | jq -e 'type' | grep -qE 'array|object'; then
                  value=$(echo "$value" | jq -c .)
                fi
              fi
              
              # Add to CloudFormation parameters
              CF_PARAMS="${CF_PARAMS} ParameterKey=${key},ParameterValue=\"${value}\""
            fi
          done < <(echo "$PARAMS" | jq -r 'keys[]')
          
          # Add required parameters from workflow inputs
          CF_PARAMS="${CF_PARAMS} ParameterKey=Family,ParameterValue=${{ inputs.task_family }}"
          CF_PARAMS="${CF_PARAMS} ParameterKey=Environment,ParameterValue=${{ inputs.environment }}"
          
          echo "parameters=${CF_PARAMS}" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          
          echo "::group::CloudFormation Parameters Preview"
          echo "$CF_PARAMS" | tr ' ' '\n'
          echo "::endgroup::"
      
      - name: Validate CloudFormation Template
        run: |
          echo "::group::Template Validation"
          aws cloudformation validate-template \
            --template-body file://${{ inputs.cloudformation_template_path }} \
            --region "${{ env.AWS_REGION }}" || exit 1
          echo "âœ… Template validation successful"
          echo "::endgroup::"
      
      # Configure AWS credentials for this job
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-ecs-taskdef-prepare-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

  ################################################################################
  # Job 3: Execute CloudFormation Operation
  ################################################################################
  deploy:
    name: Execute ${{ inputs.action }} Operation
    runs-on: ubuntu-latest
    needs: [validate, prepare]
    if: |
      needs.validate.outputs.validation_status == 'success' &&
      inputs.dry_run == false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Configure AWS credentials using OIDC
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-ecs-taskdef-deploy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
      
      ############################################################################
      # CREATE STACK
      ############################################################################
      - name: Create CloudFormation Stack
        if: inputs.action == 'create'
        id: create-stack
        run: |
          echo "::group::Creating Stack: ${{ env.STACK_NAME }}"
          
          # Read and process parameters
          PARAMS=$(cat "${{ env.PARAMETER_FILE }}")
          
          # Create a temporary file for parameters
          PARAM_FILE=$(mktemp)
          
          # Build parameter array in proper format
          echo "[" > "$PARAM_FILE"
          echo "  {\"ParameterKey\": \"Family\", \"ParameterValue\": \"${{ inputs.task_family }}\"}," >> "$PARAM_FILE"
          echo "  {\"ParameterKey\": \"Environment\", \"ParameterValue\": \"${{ inputs.environment }}\"}" >> "$PARAM_FILE"
          
          # Add parameters from JSON file
          while IFS= read -r key; do
            value=$(echo "$PARAMS" | jq -r --arg k "$key" '.[$k]')
            if [ "$value" != "null" ] && [ -n "$value" ]; then
              # For arrays and objects, keep as JSON string
              if echo "$value" | jq -e 'type' | grep -qE 'array|object' 2>/dev/null; then
                value=$(echo "$PARAMS" | jq -c --arg k "$key" '.[$k]')
              fi
              # Escape the value for JSON
              escaped_value=$(echo "$value" | jq -Rs .)
              echo "  ,{\"ParameterKey\": \"${key}\", \"ParameterValue\": ${escaped_value}}" >> "$PARAM_FILE"
            fi
          done < <(echo "$PARAMS" | jq -r 'keys[]')
          
          echo "]" >> "$PARAM_FILE"
          
          # Display parameters for debugging
          echo "CloudFormation Parameters:"
          cat "$PARAM_FILE" | jq '.'
          
          # Execute create-stack
          aws cloudformation create-stack \
            --stack-name "${{ env.STACK_NAME }}" \
            --template-body file://${{ inputs.cloudformation_template_path }} \
            --parameters file://"$PARAM_FILE" \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --tags \
              Key=Environment,Value=${{ inputs.environment }} \
              Key=ManagedBy,Value=GitHubActions \
              Key=Repository,Value=${{ github.repository }} \
              Key=Workflow,Value=${{ github.workflow }} \
              Key=RunId,Value=${{ github.run_id }} \
            --region "${{ env.AWS_REGION }}"
          
          # Cleanup
          rm -f "$PARAM_FILE"
          
          echo "Stack creation initiated"
          echo "::endgroup::"
      
      - name: Wait for Stack Creation
        if: inputs.action == 'create'
        run: |
          echo "Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}"
          echo "âœ… Stack created successfully"
      
      ############################################################################
      # UPDATE STACK
      ############################################################################
      - name: Update CloudFormation Stack
        if: inputs.action == 'update'
        id: update-stack
        run: |
          echo "::group::Updating Stack: ${{ env.STACK_NAME }}"
          
          # Read and process parameters
          PARAMS=$(cat "${{ env.PARAMETER_FILE }}")
          
          # Create a temporary file for parameters
          PARAM_FILE=$(mktemp)
          
          # Build parameter array in proper format
          echo "[" > "$PARAM_FILE"
          echo "  {\"ParameterKey\": \"Family\", \"ParameterValue\": \"${{ inputs.task_family }}\"}," >> "$PARAM_FILE"
          echo "  {\"ParameterKey\": \"Environment\", \"ParameterValue\": \"${{ inputs.environment }}\"}" >> "$PARAM_FILE"
          
          # Add parameters from JSON file
          while IFS= read -r key; do
            value=$(echo "$PARAMS" | jq -r --arg k "$key" '.[$k]')
            if [ "$value" != "null" ] && [ -n "$value" ]; then
              # For arrays and objects, keep as JSON string
              if echo "$value" | jq -e 'type' | grep -qE 'array|object' 2>/dev/null; then
                value=$(echo "$PARAMS" | jq -c --arg k "$key" '.[$k]')
              fi
              # Escape the value for JSON
              escaped_value=$(echo "$value" | jq -Rs .)
              echo "  ,{\"ParameterKey\": \"${key}\", \"ParameterValue\": ${escaped_value}}" >> "$PARAM_FILE"
            fi
          done < <(echo "$PARAMS" | jq -r 'keys[]')
          
          echo "]" >> "$PARAM_FILE"
          
          # Display parameters for debugging
          echo "CloudFormation Parameters:"
          cat "$PARAM_FILE" | jq '.'
          
          # Execute update-stack
          UPDATE_OUTPUT=$(aws cloudformation update-stack \
            --stack-name "${{ env.STACK_NAME }}" \
            --template-body file://${{ inputs.cloudformation_template_path }} \
            --parameters file://"$PARAM_FILE" \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --region "${{ env.AWS_REGION }}" 2>&1) || {
              if echo "$UPDATE_OUTPUT" | grep -q "No updates are to be performed"; then
                echo "âš ï¸  No updates needed - stack is already up to date"
                echo "no_changes=true" >> $GITHUB_OUTPUT
                rm -f "$PARAM_FILE"
                exit 0
              else
                echo "::error::Update failed: $UPDATE_OUTPUT"
                rm -f "$PARAM_FILE"
                exit 1
              fi
            }
          
          # Cleanup
          rm -f "$PARAM_FILE"
          
          echo "Stack update initiated"
          echo "no_changes=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Wait for Stack Update
        if: inputs.action == 'update' && steps.update-stack.outputs.no_changes != 'true'
        run: |
          echo "Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}"
          echo "âœ… Stack updated successfully"
      
      ############################################################################
      # DELETE STACK
      ############################################################################
      - name: Delete CloudFormation Stack
        if: inputs.action == 'delete'
        run: |
          echo "::group::Deleting Stack: ${{ env.STACK_NAME }}"
          
          # Confirm deletion in production
          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "âš ï¸  PRODUCTION STACK DELETION REQUESTED"
            echo "Stack: ${{ env.STACK_NAME }}"
            echo "Region: ${{ env.AWS_REGION }}"
          fi
          
          aws cloudformation delete-stack \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}"
          
          echo "Stack deletion initiated"
          echo "::endgroup::"
      
      - name: Wait for Stack Deletion
        if: inputs.action == 'delete'
        run: |
          echo "Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}"
          echo "âœ… Stack deleted successfully"
      
      ############################################################################
      # GET STACK OUTPUTS
      ############################################################################
      - name: Get Stack Outputs
        if: inputs.action != 'delete'
        id: stack-outputs
        run: |
          echo "::group::Stack Outputs"
          aws cloudformation describe-stacks \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Stacks[0].Outputs' \
            --output table
          echo "::endgroup::"
          
          # Export task definition ARN
          TASK_DEF_ARN=$(aws cloudformation describe-stacks \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionArn`].OutputValue' \
            --output text)
          
          echo "task_definition_arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "TASK_DEFINITION_ARN=${TASK_DEF_ARN}" >> $GITHUB_ENV

  ################################################################################
  # Job 4: Summary and Notification
  ################################################################################
  summary:
    name: Execution Summary
    runs-on: ubuntu-latest
    needs: [validate, prepare, deploy]
    if: always()
    
    steps:
      - name: Generate Execution Summary
        run: |
          echo "# ECS Task Definition Management - Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | \`${{ inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Task Family** | \`${{ inputs.task_family }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stack Name** | \`${{ env.STACK_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **AWS Region** | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dry Run** | \`${{ inputs.dry_run }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prepare | ${{ needs.prepare.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "## âœ… Operation Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ${{ inputs.action }} operation completed successfully for stack \`${{ env.STACK_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "## â„¹ï¸ Dry Run Completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Validation completed successfully. No changes were deployed." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "## âŒ Operation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The ${{ inputs.action }} operation failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "## â­ï¸ Deploy Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Deploy job was skipped due to validation failure or dry-run mode." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [CloudFormation Console](https://console.aws.amazon.com/cloudformation/home?region=${{ env.AWS_REGION }}#/stacks)" >> $GITHUB_STEP_SUMMARY
          echo "- [ECS Console](https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/taskDefinitions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
      - name: Post Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ### ECS Task Definition Management Result
            
            - **Action**: \`${{ inputs.action }}\`
            - **Environment**: \`${{ inputs.environment }}\`
            - **Task Family**: \`${{ inputs.task_family }}\`
            - **Status**: ${{ needs.deploy.result }}
            - **Stack**: \`${{ env.STACK_NAME }}\`
            
            [View Full Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
