name: Deploy ECS Task Definition via CloudFormation
on:
  workflow_dispatch:
    inputs:
      # Basic Configuration
      task_family:
        description: 'Task Definition family name (e.g., feedback-service)'
        required: true
        type: string
      environment:
        description: 'Environment'
        required: true
        type: choice
        options: [dev, qa, perf, staging, prod]
      action:
        description: 'Action'
        required: true
        type: choice
        options: [validate, create, update]
        default: validate
      
      # Task Level Configuration
      task_cpu:
        description: 'Task CPU units'
        required: true
        type: choice
        options: ['256', '512', '1024', '2048', '4096']
        default: '512'
      task_memory:
        description: 'Task Memory (MB)'
        required: true
        type: choice
        options: ['512', '1024', '2048', '3072', '4096', '8192', '16384']
        default: '1024'
      requires_compatibilities:
        description: 'Launch Type'
        required: true
        type: choice
        options: ['FARGATE', 'EC2']
        default: 'FARGATE'
      
      # Container Configuration
      container_name:
        description: 'Container name'
        required: true
        type: string
        default: 'app'
      container_image:
        description: 'Container image URI (e.g., 123456.dkr.ecr.region.amazonaws.com/app:tag)'
        required: true
        type: string
      container_memory:
        description: 'Container memory (MB)'
        required: true
        type: string
        default: '1024'
      container_cpu:
        description: 'Container CPU units (0 = use task-level)'
        required: false
        type: string
        default: '0'
      container_port:
        description: 'Container port'
        required: true
        type: string
        default: '8080'
      host_port:
        description: 'Host port'
        required: false
        type: string
        default: ''
      essential:
        description: 'Essential container'
        required: true
        type: choice
        options: ['true', 'false']
        default: 'true'
      
      # IAM Roles
      execution_role_arn:
        description: 'Execution Role ARN (required for Fargate)'
        required: true
        type: string
      task_role_arn:
        description: 'Task Role ARN (optional)'
        required: false
        type: string
        default: ''
      
      # Logging
      log_group_name:
        description: 'CloudWatch log group (leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      log_stream_prefix:
        description: 'Log stream prefix'
        required: false
        type: string
        default: 'ecs'
      
      # Environment Variables
      env_vars:
        description: 'Environment variables (KEY1=VALUE1,KEY2=VALUE2)'
        required: false
        type: string
        default: ''
      
      # Health Check
      health_check_command:
        description: 'Health check command (CMD-SHELL,curl -f http://localhost:8080/health || exit 1)'
        required: false
        type: string
        default: ''
      health_check_interval:
        description: 'Health check interval (seconds)'
        required: false
        type: string
        default: '30'
      health_check_timeout:
        description: 'Health check timeout (seconds)'
        required: false
        type: string
        default: '5'
      health_check_retries:
        description: 'Health check retries'
        required: false
        type: string
        default: '3'
      health_check_start_period:
        description: 'Health check start period (seconds)'
        required: false
        type: string
        default: '60'
      
      # Runtime Platform
      runtime_cpu_architecture:
        description: 'CPU Architecture'
        required: false
        type: choice
        options: ['X86_64', 'ARM64']
        default: 'X86_64'
      runtime_os_family:
        description: 'OS Family'
        required: false
        type: choice
        options: ['LINUX', 'WINDOWS_SERVER_2019_FULL', 'WINDOWS_SERVER_2022_FULL']
        default: 'LINUX'
      
      # Storage
      ephemeral_storage_size:
        description: 'Ephemeral storage (GiB)'
        required: false
        type: string
        default: '20'
      
      # Tags
      team:
        description: 'Team name'
        required: false
        type: string
        default: 'DevOps'
      cost_center:
        description: 'Cost Center'
        required: false
        type: string
        default: ''
      project:
        description: 'Project name'
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-south-1
  TEMPLATE_FILE: task-CTF.yaml

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      stack_name: ${{ steps.naming.outputs.stack_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build stack name
        id: naming
        run: |
          set -euo pipefail
          STACK_NAME="taskdef-${{ inputs.task_family }}-${{ inputs.environment }}-stack"
          echo "stack_name=$STACK_NAME" >> "$GITHUB_OUTPUT"
          
          echo "### Inputs Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Task Family**: ${{ inputs.task_family }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Environment**: ${{ inputs.environment }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Action**: ${{ inputs.action }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Container Image**: ${{ inputs.container_image }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Task CPU**: ${{ inputs.task_cpu }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Task Memory**: ${{ inputs.task_memory }} MB" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Launch Type**: ${{ inputs.requires_compatibilities }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: Validate-TaskDef-${{ inputs.task_family }}

      - name: Validate CloudFormation template
        run: |
          set -euo pipefail
          aws cloudformation validate-template --template-body file://${{ env.TEMPLATE_FILE }}
          echo "âœ… SUCCESS: CloudFormation template is valid." >> "$GITHUB_STEP_SUMMARY"

      - name: Validate IAM Role
        run: |
          set -euo pipefail
          ROLE_ARN="${{ inputs.execution_role_arn }}"
          ROLE_NAME=$(echo "$ROLE_ARN" | awk -F'/' '{print $NF}')
          
          aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1 || {
            echo "âŒ ERROR: IAM role '$ROLE_NAME' not found."
            exit 1
          }
          echo "âœ… SUCCESS: IAM role '$ROLE_NAME' exists." >> "$GITHUB_STEP_SUMMARY"

      - name: Validate CPU/Memory Combination
        run: |
          set -euo pipefail
          CPU=${{ inputs.task_cpu }}
          MEMORY=${{ inputs.task_memory }}
          COMPAT="${{ inputs.requires_compatibilities }}"
          
          if [ "$COMPAT" = "FARGATE" ]; then
            VALID=false
            case "$CPU" in
              256)
                [[ "$MEMORY" =~ ^(512|1024|2048)$ ]] && VALID=true
                ;;
              512)
                [[ "$MEMORY" =~ ^(1024|2048|3072|4096)$ ]] && VALID=true
                ;;
              1024)
                [[ "$MEMORY" =~ ^(2048|3072|4096|5120|6144|7168|8192)$ ]] && VALID=true
                ;;
              2048)
                [[ "$MEMORY" =~ ^(4096|5120|6144|7168|8192|9216|10240|11264|12288|13312|14336|15360|16384)$ ]] && VALID=true
                ;;
              4096)
                [[ "$MEMORY" -ge 8192 ]] && [[ "$MEMORY" -le 30720 ]] && VALID=true
                ;;
            esac
            
            if [ "$VALID" = "false" ]; then
              echo "âŒ ERROR: Invalid CPU/Memory combination for Fargate"
              echo "CPU: $CPU, Memory: $MEMORY"
              echo "See: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html"
              exit 1
            fi
            echo "âœ… SUCCESS: CPU/Memory combination is valid for Fargate." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Validate Container Memory
        run: |
          set -euo pipefail
          TASK_MEM=${{ inputs.task_memory }}
          CONTAINER_MEM=${{ inputs.container_memory }}
          
          if [ "$CONTAINER_MEM" -gt "$TASK_MEM" ]; then
            echo "âŒ ERROR: Container memory ($CONTAINER_MEM) cannot exceed task memory ($TASK_MEM)"
            exit 1
          fi
          echo "âœ… SUCCESS: Container memory is within task memory limits." >> "$GITHUB_STEP_SUMMARY"

  deploy:
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: ${{ inputs.action == 'create' || inputs.action == 'update' }}
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: Deploy-TaskDef-${{ inputs.task_family }}

      - name: Create or Update CloudFormation Stack
        run: |
          set -euo pipefail
          STACK="${{ needs.validate-inputs.outputs.stack_name }}"
          
          # Check if stack exists
          EXISTS="false"
          aws cloudformation describe-stacks --stack-name "$STACK" >/dev/null 2>&1 && EXISTS="true"
          
          # Enforce create/update rules
          if [ "${{ inputs.action }}" = "create" ]; then
            if [ "$EXISTS" = "true" ]; then
              echo "âŒ ERROR: Stack '$STACK' already exists. Use 'update' action instead."
              exit 1
            fi
            ACTION="create-stack"
          else
            if [ "$EXISTS" = "false" ]; then
              echo "âŒ ERROR: Stack '$STACK' does not exist. Use 'create' action instead."
              exit 1
            fi
            ACTION="update-stack"
          fi

          # Set host port (default to container port if not specified)
          HOST_PORT="${{ inputs.host_port }}"
          if [ -z "$HOST_PORT" ]; then
            HOST_PORT="${{ inputs.container_port }}"
          fi

          # Build parameter overrides from workflow inputs
          PARAMS="Family=${{ inputs.task_family }}"
          PARAMS="$PARAMS Environment=${{ inputs.environment }}"
          PARAMS="$PARAMS TaskCpu=${{ inputs.task_cpu }}"
          PARAMS="$PARAMS TaskMemory=${{ inputs.task_memory }}"
          PARAMS="$PARAMS RequiresCompatibilities=${{ inputs.requires_compatibilities }}"
          PARAMS="$PARAMS ContainerName=${{ inputs.container_name }}"
          PARAMS="$PARAMS ContainerImage=${{ inputs.container_image }}"
          PARAMS="$PARAMS ContainerMemory=${{ inputs.container_memory }}"
          PARAMS="$PARAMS ContainerCpu=${{ inputs.container_cpu }}"
          PARAMS="$PARAMS ContainerPort=${{ inputs.container_port }}"
          PARAMS="$PARAMS HostPort=$HOST_PORT"
          PARAMS="$PARAMS Essential=${{ inputs.essential }}"
          PARAMS="$PARAMS ExecutionRoleArn=${{ inputs.execution_role_arn }}"
          PARAMS="$PARAMS TaskRoleArn=${{ inputs.task_role_arn }}"
          PARAMS="$PARAMS LogGroupName=${{ inputs.log_group_name }}"
          PARAMS="$PARAMS LogStreamPrefix=${{ inputs.log_stream_prefix }}"
          PARAMS="$PARAMS EnvironmentVariables=${{ inputs.env_vars }}"
          PARAMS="$PARAMS HealthCheckCommand=${{ inputs.health_check_command }}"
          PARAMS="$PARAMS HealthCheckInterval=${{ inputs.health_check_interval }}"
          PARAMS="$PARAMS HealthCheckTimeout=${{ inputs.health_check_timeout }}"
          PARAMS="$PARAMS HealthCheckRetries=${{ inputs.health_check_retries }}"
          PARAMS="$PARAMS HealthCheckStartPeriod=${{ inputs.health_check_start_period }}"
          PARAMS="$PARAMS RuntimePlatformCpuArchitecture=${{ inputs.runtime_cpu_architecture }}"
          PARAMS="$PARAMS RuntimePlatformOperatingSystemFamily=${{ inputs.runtime_os_family }}"
          PARAMS="$PARAMS EphemeralStorageSize=${{ inputs.ephemeral_storage_size }}"
          PARAMS="$PARAMS Team=${{ inputs.team }}"
          PARAMS="$PARAMS CostCenter=${{ inputs.cost_center }}"
          PARAMS="$PARAMS Project=${{ inputs.project }}"

          echo "### CloudFormation Parameters" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "$PARAMS" | tr ' ' '\n' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          # Execute CloudFormation operation
          aws cloudformation "$ACTION" \
            --stack-name "$STACK" \
            --template-body file://${{ env.TEMPLATE_FILE }} \
            --parameter-overrides $PARAMS \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --tags \
              Key=Family,Value=${{ inputs.task_family }} \
              Key=Environment,Value=${{ inputs.environment }} \
              Key=ManagedBy,Value=GitHubActions \
              Key=Repository,Value=${{ github.repository }}

      - name: Wait for Stack
        run: |
          set -euo pipefail
          STACK="${{ needs.validate-inputs.outputs.stack_name }}"
          
          if [ "${{ inputs.action }}" = "create" ]; then
            echo "â³ Waiting for stack creation..."
            aws cloudformation wait stack-create-complete --stack-name "$STACK" || {
              echo "âŒ ERROR: Stack creation failed!"
              aws cloudformation describe-stack-events \
                --stack-name "$STACK" \
                --query 'StackEvents[?ResourceStatus==`CREATE_FAILED`].[LogicalResourceId,ResourceStatusReason]' \
                --output table
              exit 1
            }
          else
            echo "â³ Waiting for stack update..."
            set +e
            aws cloudformation wait stack-update-complete --stack-name "$STACK"
            EXIT=$?
            set -e
            
            if [ "$EXIT" -ne 0 ]; then
              STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK" --query 'Stacks[0].StackStatus' --output text)
              if [[ "$STATUS" == "UPDATE_COMPLETE" || "$STATUS" == "UPDATE_COMPLETE_CLEANUP_IN_PROGRESS" ]]; then
                echo "âœ… Update completed successfully."
              else
                echo "âŒ ERROR: Update failed with status: $STATUS"
                aws cloudformation describe-stack-events \
                  --stack-name "$STACK" \
                  --query 'StackEvents[?ResourceStatus==`UPDATE_FAILED`].[LogicalResourceId,ResourceStatusReason]' \
                  --output table
                exit 1
              fi
            fi
          fi
          echo "âœ… SUCCESS: Stack operation completed." >> "$GITHUB_STEP_SUMMARY"

      - name: Get Task Definition Details
        run: |
          set -euo pipefail
          STACK="${{ needs.validate-inputs.outputs.stack_name }}"
          
          # Get outputs
          TASKDEF_ARN=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionArn`].OutputValue' \
            --output text)
          
          TASKDEF_FAMILY=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionFamily`].OutputValue' \
            --output text)
          
          TASKDEF_REVISION=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionRevision`].OutputValue' \
            --output text)
          
          echo "### ðŸŽ‰ Task Definition Created/Updated" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ARN**: \`$TASKDEF_ARN\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Family**: \`$TASKDEF_FAMILY\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Revision**: \`$TASKDEF_REVISION\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          # Get task definition details
          echo "### Task Definition Details" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          aws ecs describe-task-definition \
            --task-definition "$TASKDEF_ARN" \
            --query 'taskDefinition.[family,revision,status,cpu,memory,requiresCompatibilities[0],networkMode]' \
            --output table >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### âœ… Ready to Deploy" >> "$GITHUB_STEP_SUMMARY"
          echo "Use this task definition in your ECS Service:" >> "$GITHUB_STEP_SUMMARY"
          echo "- **TaskDefinitionFamily**: \`$TASKDEF_FAMILY\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **TaskDefinitionRevision**: \`$TASKDEF_REVISION\` or \`latest\`" >> "$GITHUB_STEP_SUMMARY"
